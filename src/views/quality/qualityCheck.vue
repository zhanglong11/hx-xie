<!-- * @Description: 检验批详情 * @Version: * @Autor: * @Date: 2020-02-25 18:16:15 * @LastEditTime: 2020-03-02 16:10:28 --><!--* @任务编号:2620||质量接口对接* @开发人员:张龙* @日期:2020-03-16* @任务类型: 修改代码--><!--* @任务编号:2620||质量详情接口对接，对接途中，接口报错，后端正在解决* @开发人员:张龙* @日期:2020-03-17* @任务类型: 修改代码--><template>  <div class="check">    <div v-if="!detailsFlag">      <div>        <el-input v-model="pageQuery.search" placeholder="请输入">          <el-button slot="append" icon="el-icon-search" @click="refresh"></el-button>        </el-input>      </div>      <div class="tree">        <!--  * @任务编号: 2620 || 实现tree处于打开状态  * @开发人员:张龙  * @日期:2020-03-25  * @任务类型: 新代码  -->        <el-tree          ref="tree"          default-expand-all          :data="treeData"          :props="defaultProps"          :expand-on-click-node="false"          @node-click="handleNodeClick"          :filter-node-method="filterNode"        >          <span slot-scope="{ node, data }">            <span :class="'type' + data.type" class="tree-title" @click="getData(data)" :title="data.name">              {{ data.number }}              {{ data.name }}            </span>            <span class="point" :style="{ backgroundColor: data.acceptanceId ? 'green' : 'red' }"></span>          </span>        </el-tree>      </div>    </div>    <!--    <Block title="统计" sub-title="cost">-->    <!--      &lt;!&ndash; 圆环示意图 &ndash;&gt;-->    <!--      <MyEchart :total="total" :unqualified="unqualified" />-->    <!--    </Block>-->    <!-- 检验批缩略图 -->    <LogThumbnail      v-if="selectObj.type === 5 && !detailsFlag"      :id="curId"      :total="total"      :unqualified="unqualified"      @goDetails="goDetails"    />    <!-- 检验批详情 -->    <InspectionLot v-if="selectObj.type === 5 && detailsFlag" :id="curId" @goBack="goBack" />    <!-- 分部详情缩略图 -->    <LotBranch      v-if="selectObj.type !== 5 && !detailsFlag"      :id="curId"      :total="total"      :unqualified="unqualified"      :type="sectionType"      @goDetails="goDetails"    />    <LotBranchDetails v-if="selectObj.type !== 5 && detailsFlag" :id="curId" :type="sectionType" @goBack="goBack" />  </div></template><script>import api from '@/api/quality'import toTree from '@/utils/toTree'// 检验批验收缩略图import LogThumbnail from './components/LogThumbnail'// 检验批详情图import InspectionLot from './components/InspectionLot'// 分部分项缩略图import LotBranch from './components/LotBranch'import LotBranchDetails from './components/LotBranchDetails'import MyEchart from './components/Echarts'export default {  components: {    LogThumbnail,    InspectionLot,    LotBranch,    LotBranchDetails,    MyEchart  },  data() {    return {      // 详情页面flag      detailsFlag: false,      //选中的tree节点      selectObj: {        type: ''      },      typeList: [        { label: '单位工程', value: 1 },        { label: '分部工程', value: 2 },        { label: '子分部工程', value: 3 },        { label: '分项工程', value: 4 },        { label: '检验批', value: 5 }      ],      pageQuery: {        search: ''      },      defaultProps: {},      search: '',      // type：1为检验批，2为分部工程      treeData: [],      curId: null,      sectionType: null,      total: 0,      unqualified: 0    }  },  created() {    this.refresh()  },  methods: {    async refresh() {      let res = await api.tree(this.pageQuery)      this.treeData = toTree(res.data.treeList)      this.curId = this.treeData[0].acceptanceId      this.sectionType = this.treeData[0].type      this.total = res.data.allCount      this.unqualified = res.data.passCount      console.log(this.total)      console.log(this.unqualified)    },    goBack() {      this.detailsFlag = false      this.$emit('goBack')    },    goDetails() {      this.detailsFlag = true      this.$emit('goDetails')    },    filterNode(value, data) {      if (!value) return true      return data.label.indexOf(value) !== -1    },    /*     * @任务编号:2620||质量接口替换逻辑更改     * @开发人员:张龙     * @日期:2020-03-20     * @任务类型: 修改代码     */    async handleNodeClick(e) {      if (!e.acceptanceId) {        this.$message.error('当前数据没有验收')        return      }      const res = await api.getAcceptGuid(e.acceptanceId)      if (res.data.componentIdList.length) {        this.fitViewByGUID(res.data.componentIdList)      }      this.selectObj = e      this.curId = e.acceptanceId      this.sectionType = e.type    },    // 根据guid定位并添加标注    fitViewByGUID(guidArray) {      let bimfishApp = this.$store.state.bim.bimfishApp      // 添加标注      const icon = '/img/qualityCheck.png'      bimfishApp.addDrawableIconMarkerByGUID(guidArray, icon, ({ screenPoint, guid }) => {        console.log('screenPoint:', screenPoint, guid)      })      // 定位      bimfishApp.fitViewByGUID(guidArray)    },    getData(data) {      console.log(data)    }  }}</script><style lang="less" scoped>.goDetails {  font-size: 12px;  color: #229edd;  background: #092138;  border: 1px solid #053958;  padding: 2px 4px;  // margin-bottom: -2px;}.tree {  margin-bottom: 20px;}.add {  padding-left: 9px;  color: red;}.reduce {  padding-left: 9px;  color: green;}.check /deep/ ul {  font-size: 13px;  background-color: #030e25;  li {    padding: 14px 16px;    border-bottom: 1px dashed #3f4654;    .title {      color: #356294;      padding-bottom: 10px;    }    .desc {      color: #85add2;      &.key-pont {        color: #dcc51d;      }    }  }  .li-flex {    display: flex;    justify-content: space-between;    div {      flex: 1;      overflow: hidden;    }    .center {      border-left: 1px solid #3f4654;      border-right: 1px solid #3f4654;      padding: 0 10px;    }    .b-l {      border-left: 1px solid #3f4654;    }  }}.tree-title {  overflow-x: hidden;  display: inline-block;  max-width: 200px;  text-overflow: ellipsis;}.point {  display: inline-flex;  width: 8px;  height: 8px;  margin-left: 4px;  border-radius: 50%;  vertical-align: 7px;}</style>